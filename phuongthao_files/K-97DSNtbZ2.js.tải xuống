;/*FB_PKG_DELIM*/

__d("MJewelThreads",["Bootloader","ChannelEventType","ReactDOM_DEPRECATED","Stratcom"],(function(a,b,c,d,e,f,g){"use strict";a=function(){function a(a){var b=this;this.onJewelOpen=function(a){a=a.getData();a=a&&a.jewel&&a.jewel==="messages";a&&b.$4&&b.updateUI()};this.onThreadClick=function(a){a=a.getNode("live-thread");if(!a)return;b.setThreadReadStatus(a.getAttribute("data-fbid"),a.getAttribute("data-canonical")==="true",!0);b.updateUI()};this.onMessageEvent=function(a){var c=a.getData();if(c.parsedPayload){a=c.parsedPayload;if(a.getFolder()!=="inbox")return;b.$3||(b.$3=!0,b.registerListeners());b.addThread(a)}else if(Object.prototype.hasOwnProperty.call(c,"mark_as_read"))c.other_user_fbids.forEach(function(a){b.setThreadReadStatus(a.toString(),!0,c.mark_as_read)}),c.thread_fbids.forEach(function(a){b.setThreadReadStatus(a.toString(),!1,c.mark_as_read)}),b.updateUI();else if(c.event==="read"&&c.is_sync){a=!!c.message.other_user_fbid;var d=a?c.message.other_user_fbid:c.message.thread_fbid;b.setThreadReadStatus(d,a,!0);b.updateUI()}};this.$1=a;this.$2=[];this.$3=!1;this.$4=!1;c("Stratcom").listen(d("ChannelEventType").MESSAGE,null,this.onMessageEvent.bind(this))}var b=a.prototype;b.getThreads=function(){return this.$2};b.registerListeners=function(){c("Stratcom").listen("click","live-threads",this.onThreadClick.bind(this)),c("Stratcom").listen("m:jewel:flyout:open",null,this.onJewelOpen.bind(this))};b.addThread=function(a){var b=this;this.$2=this.$2.filter(function(c){c=c.isCanonicalThread()?c.getOtherUserFBID():c.getThreadFBID();return!b.isSameThread(c,a.isCanonicalThread(),a)});a.unread=a.isUnread();this.$2.push(a);this.$4=!0;this.updateThreadImage(a)};b.updateThreadImage=function(a){var b=this;c("Bootloader").loadModules(["MMessagesThreadMetadataCache","MShortProfiles"],function(c,d){if(a.hasThreadImage())c.get(a.getThreadFBID(),function(c){a.image_src=c.image_src,b.updateUI()});else{c=a.isCanonicalThread()?a.getOtherUserFBID():a.getAuthorFBID();d.get(c,function(c){a.image_src=c.mThumbSrcSmall,b.updateUI()})}},"MJewelThreads")};b.setThreadReadStatus=function(a,b,c){var d=this;this.$2.forEach(function(e){d.isSameThread(a,b,e)&&(e.unread==c&&(d.$4=!0),e.unread=!c)})};b.isSameThread=function(a,b,c){b=b?c.getOtherUserFBID():c.getThreadFBID();return a==b};b.updateUI=function(){var a=this;if(!this.$3||!this.$4)return;c("Bootloader").loadModules(["react","ReactDOM","MJewelThreadList.react","PopoverMobile"],function(b,c,e,f){if(!f.getInstance("messages_flyout").isOpen())return;c={threads:a.$2};d("ReactDOM_DEPRECATED").render_DEPRECATED(b.jsx(e,babelHelpers["extends"]({},c)),a.$1);f.getInstance("messages_flyout").refreshConstraints();a.$4=!1},"MJewelThreads")};return a}();g["default"]=a}),98);
__d("XFBConfirmationCliffTypedLogger",["Banzai","GeneratedLoggerUtils","nullthrows"],(function(a,b,c,d,e,f){"use strict";a=function(){function a(){this.$1={}}var c=a.prototype;c.log=function(a){b("GeneratedLoggerUtils").log("logger:XFBConfirmationCliffLoggerConfig",this.$1,b("Banzai").BASIC,a)};c.logVital=function(a){b("GeneratedLoggerUtils").log("logger:XFBConfirmationCliffLoggerConfig",this.$1,b("Banzai").VITAL,a)};c.logImmediately=function(a){b("GeneratedLoggerUtils").log("logger:XFBConfirmationCliffLoggerConfig",this.$1,{signal:!0},a)};c.clear=function(){this.$1={};return this};c.getData=function(){return babelHelpers["extends"]({},this.$1)};c.updateData=function(a){this.$1=babelHelpers["extends"]({},this.$1,a);return this};c.setCliffCaller=function(a){this.$1.cliff_caller=a;return this};c.setError=function(a){this.$1.error=a;return this};c.setSurface=function(a){this.$1.surface=a;return this};c.updateExtraData=function(a){a=b("nullthrows")(b("GeneratedLoggerUtils").serializeMap(a));b("GeneratedLoggerUtils").checkExtraDataFieldNames(a,g);this.$1=babelHelpers["extends"]({},this.$1,a);return this};c.addToExtraData=function(a,b){var c={};c[a]=b;return this.updateExtraData(c)};return a}();var g={cliff_caller:!0,error:!0,surface:!0};f["default"]=a}),66);
__d("XMessagesJewelContentController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/mobile/messages/jewel/content/",{spinner_id:{type:"String",required:!0}})}),null);
__d("MMessagesJewel",["fbt","invariant","Arbiter","ChannelEventType","EventListener","MDOM","MJewel","MJewelFlyout","MJewelLinkFetcher","MJewels","MLogState","MMessagesThreadRowID","MPageCache","MPageFetcher","MRequest","MURI","PopoverMobile","Stratcom","XFBConfirmationCliffTypedLogger","XMessagesJewelContentController","ge","onAfterDisplay","onAfterTTI","throttle"],(function(a,b,c,d,e,f,g,h){"use strict";var i="mJewelMsgThreadContents",j="msg_",k,l,m=!1,n=!1,o,p=!1,q=!0,r=!1,s=0;function t(){k||h(0,2795);b("Arbiter").subscribe("m:jewels:init-counts",w,"all");k.listen("cleared",y);if(!p){var a;p=!0;(a=b("Stratcom")).listen(b("ChannelEventType").MESSAGE,null,C);a.listen(b("ChannelEventType").MESSAGE,null,z);a.listen("m:jewel:flyout:open",null,x);a.listen("m:history:change",null,u);l&&b("EventListener").listen(l,"click",v)}}function u(a){var c=new(b("MURI"))(a.getData().path).normalize().toString();a=a.getData().soft;var d=new(b("MURI"))(b("MJewelLinkFetcher").get("messages")).normalize().toString();m&&c!==d?q=!0:!m&&a!=="messages"&&(q=!0)}function v(){q&&(s=0,q=!1,m&&k&&k.getCount()>0&&(k&&k.setCount(0))),r=!0}function w(a,b){a=b.viewer_id;var c=b.unseen_thread_ids;b=b.unread_thread_ids;a&&(H.viewerID=a);c&&(H.unseenThreadIDs=c.reduce(function(a,b){a[b]=1;return a},{}));b&&(H.unreadThreadIDs=b.reduce(function(a,b){a[b]=1;return a},{}));c&&k&&(k.reregisterListeners(),s=c.length,k.updateCount(c.length,y))}function x(a){a=a.getData();if(!k||a.jewel!=="messages")return;H.messengerCliff&&new(b("XFBConfirmationCliffTypedLogger"))().setSurface("messenger_seen").log();a=k.getCount();k.setCount(a);B()}function y(){var a=new(b("MRequest"))(new(b("MURI"))("/a/jewel_messages_read.php").toString());a.send()}function z(a){a=a.getData();if(!a||!k)return;if(a.event==="read"&&a.message.folder==="inbox"){var b=a.message.thread_fbid||a.message.other_user_fbid;delete H.unseenThreadIDs[b];delete H.unreadThreadIDs[b]}else if(a.event==="unread"&&a.message.folder==="inbox"){b=a.message.thread_fbid||a.message.other_user_fbid;H.unreadThreadIDs[b]=1}else if(a.event==="mark_all_read"&&a.message.folder==="inbox")H.unreadThreadIDs={},H.unseenThreadIDs={};else if(a.event==="mark_all_seen"&&a.message.folder==="inbox")H.unseenThreadIDs={};else if(a.parsedPayload&&a.folder==="inbox"){b=a.parsedPayload;if(!A(H.viewerID,b)||b.isUnread()===!1||a.message.is_muted)return;a=b.getThreadFBID()||b.getOtherUserFBID();H.unseenThreadIDs[a]=1;H.unreadThreadIDs[a]=1}else return;b=Object.keys(H.unseenThreadIDs).length;a=Object.keys(H.unreadThreadIDs).length;var c=s;!k.isOpen()&&b!==k.getCount()&&(s=b,k.setCount(b));b=a>0?g._("Tin nh\u1eafn ({unread_message_count})",[g._param("unread_message_count",a)]):g._("Tin nh\u1eafn");a=k.getFlyout();a&&a.setHeaderText("messages_jewel_header_text",b.toString());G(c<s)}function A(a,b){if(!b.getParticipantIDs())return!1;if(b.getParticipantIDs().indexOf(a)>-1)return!0;if(a)return b.getParticipantIDs().indexOf(a.toString())>-1;else return!1}function B(){k||h(0,2795);var a="messages-flyout-loading";a=b("MDOM").scry(l,"*",a);if(a.length>0){a=b("XMessagesJewelContentController").getURIBuilder().setString("spinner_id",a[0].getAttribute("id")).getURI();o||(o=new(b("MRequest"))(a),o.listen("finally",function(){o=null}),o.send())}}function C(a){a=a.getData();if(!a||!k)return;if(a.parsedPayload){var c=a.parsedPayload;if(!c.getFolder||c.getFolder()!=="inbox"||!A(H.viewerID,c))return;k.isInitialized()&&(b("MJewelFlyout").removeMenuContent(D(c.getOtherUserFBID(),c.getThreadFBID())),k.isOpen()&&y());m||B()}else a.event==="read"&&a.is_sync&&b("MJewelFlyout").updateMenuColor(D(a.message.other_user_fbid,a.message.thread_fbid),!0,!1)}function D(a,c){return b("MMessagesThreadRowID").getThreadRowID(j,a,c)}function E(a){var c=function(){r||F(!1)};switch(a){case"asap":c();break;case"after-tti":b("onAfterTTI")(c);break;case"after-dd":b("onAfterDisplay")(c);break}}var F=b("throttle")(function(a){var c=b("MJewelLinkFetcher").get("messages");if(!c)return;a&&b("MPageCache").removeCachedPage(c);b("MPageFetcher").prefetch(c)},100);function G(a){n&&F(!0)}var H={unseenThreadIDs:{},unreadThreadIDs:{},viewerID:null,messengerCliff:!1,initJewel:function(a){m=!!a.noFlyout,k=b("MJewel").create("messages",{contentsSigil:i,pos:b("MLogState").CLICK_POSITION_MESSAGES_FLYOUT,softState:b("MJewels").MESSAGES,noPopover:m,additionalPaths:["/messages/"]}),l=b("MDOM").find(b("ge")("MChromeHeader"),"div","messages"),n=!!a.shouldPrefetch,a.shouldPrefetch&&E(a.initialPrefetchPhase),t()},setMessengerCliff:function(a,b,c){H.messengerCliff=a},refreshMessagesConstraints:function(){b("PopoverMobile").getInstance("messages_flyout").refreshConstraints()}};e.exports=H}),130);
__d("MPresenceIcon",["MDOM","MLegacyDataStore","MRequest","MURI","Stratcom","Visibility","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){var g=1,h=2,i=6e4,j=null;function k(){var a=b("MDOM").scry(document.body,"i","presence-icon"),c=[];for(var d=0,e=a.length;d<e;++d){var f=b("MLegacyDataStore").get(a[d]);f.userid&&!c[f.userid]&&(c[f.userid]=1)}if(c.length==0||b("Visibility").isHidden()){window.clearTimeout(j);j=b("setTimeoutAcrossTransitions")(k,i);return}f=new(b("MURI"))("/chat/presence_icon.php").toString();d=new(b("MRequest"))(f).setData({ids:Object.keys(c)}).setIgnoreErrors(!0);d.listen("done",function(e){for(var c=0,d=a.length;c<d;++c){var f=b("MLegacyDataStore").get(a[c]);f&&f.userid&&b("Stratcom").hasSigil(a[c],"online-icon")&&e[f.userid]==g||b("Stratcom").hasSigil(a[c],"mobile-icon")&&e[f.userid]==h?b("MDOM").show(a[c]):b("MDOM").hide(a[c])}});d.listen("finally",function(a){window.clearTimeout(j),j=b("setTimeoutAcrossTransitions")(k,i)});d.send()}k()}),null);
__d("MTouchChannelManager",["Bootloader","MChannelManager","Run","gkx","onAfterDisplay"],(function(a,b,c,d,e,f,g){var h=!1;function a(a){a===void 0&&(a=!1);if(h)return;h=!0;c("MChannelManager").addListener(c("MChannelManager").CHANNEL_MESSAGE,function(a){return c("Bootloader").loadModules(["MTouchChannelPayloadRouter"],function(b){return b.route(a)},"MTouchChannelManager")});!a&&c("gkx")("9046")?c("gkx")("9062")?d("Run").onAfterLoad(c("MChannelManager").startChannel):c("onAfterDisplay")(c("MChannelManager").startChannel):c("MChannelManager").startChannel()}g.initialize=a}),98);